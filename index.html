<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadBuddy - AI Reading Helper üìö</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #FF6B9D;
            --primary-dark: #E85384;
            --secondary: #4ECDC4;
            --secondary-dark: #3AB8AF;
            --accent: #FFD93D;
            --success: #6BCF7F;
            --warning: #FFA756;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-paper: #FFFEF9;
            --text-dark: #2D3748;
            --text-light: #718096;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --border-radius: 24px;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 157, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(78, 205, 196, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 217, 61, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        #root {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--border-radius);
            padding: 40px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .header::before {
            content: '‚ú®';
            position: absolute;
            font-size: 120px;
            top: -20px;
            right: -10px;
            opacity: 0.15;
            animation: sparkle 3s infinite;
        }
        
        .header::after {
            content: 'üìö';
            position: absolute;
            font-size: 100px;
            bottom: -10px;
            left: -10px;
            opacity: 0.15;
            animation: float 6s infinite;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }
        
        .logo {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .logo-icon {
            font-size: 4em;
            animation: pulse 2s infinite;
        }
        
        .logo-text h1 {
            font-family: 'Baloo 2', cursive;
            font-size: 3.5em;
            font-weight: 800;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
            margin: 0;
            letter-spacing: -1px;
        }
        
        .tagline {
            color: rgba(255,255,255,0.95);
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }
        
        @media (max-width: 968px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }
        
        .sidebar {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow-md);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .level-selector h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .level-btn {
            width: 100%;
            padding: 18px 20px;
            margin-bottom: 12px;
            border: 3px solid transparent;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-size: 1.05em;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .level-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .level-btn:hover::before {
            left: 100%;
        }
        
        .level-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .level-btn.active {
            background: linear-gradient(135deg, var(--primary), #FF8FB1);
            color: white;
            border-color: var(--primary-dark);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
        }
        
        .level-icon {
            font-size: 2em;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }
        
        .progress-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 3px solid #f0f0f0;
        }
        
        .progress-section h3 {
            color: var(--secondary);
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar-container {
            background: #e2e8f0;
            height: 28px;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--secondary));
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 14px;
            position: relative;
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.4);
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            text-align: center;
            margin-top: 12px;
            font-weight: 700;
            color: var(--text-dark);
            font-size: 1.05em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f7fafc 100%);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 8px;
            font-weight: 600;
        }
        
        .content-area {
            background: white;
            border-radius: var(--border-radius);
            padding: 45px;
            box-shadow: var(--shadow-md);
            min-height: 600px;
        }
        
        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 3px solid #f0f0f0;
        }
        
        .lesson-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .lesson-title h2 {
            font-family: 'Baloo 2', cursive;
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .word-counter {
            background: linear-gradient(135deg, var(--accent), #FFE66D);
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 700;
            color: var(--text-dark);
            box-shadow: var(--shadow-sm);
        }
        
        .lesson-card {
            background: linear-gradient(135deg, #fff 0%, #fffef9 100%);
            border: 3px solid var(--accent);
            border-radius: 24px;
            padding: 45px;
            margin-bottom: 30px;
            box-shadow: 0 12px 35px rgba(255, 217, 61, 0.25);
            position: relative;
            overflow: hidden;
        }
        
        .lesson-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 217, 61, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .word-display {
            text-align: center;
            margin: 45px 0;
            position: relative;
            z-index: 1;
        }
        
        .current-word {
            font-family: 'Baloo 2', cursive;
            font-size: 6em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            filter: drop-shadow(4px 4px 0px rgba(255, 217, 61, 0.3));
            animation: bounceIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .current-word:hover {
            transform: scale(1.1) rotate(-2deg);
        }
        
        @keyframes bounceIn {
            0% { 
                transform: scale(0) rotate(-180deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.2) rotate(10deg); 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        .phonetic-text {
            font-size: 1.6em;
            color: var(--text-light);
            font-style: italic;
            margin-bottom: 15px;
        }
        
        .image-container {
            width: 100%;
            max-width: 550px;
            margin: 35px auto;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            position: relative;
            border: 4px solid white;
        }
        
        .image-container img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            display: block;
            transition: transform 0.3s;
        }
        
        .image-container:hover img {
            transform: scale(1.05);
        }
        
        .image-loading {
            width: 100%;
            height: 350px;
            background: linear-gradient(90deg, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 4em;
        }
        
        .loading-text {
            font-size: 0.3em;
            margin-top: 20px;
            color: var(--text-light);
            font-weight: 700;
        }
        
        .caption {
            text-align: center;
            font-size: 1.5em;
            color: var(--text-dark);
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 217, 61, 0.15);
            border-radius: 16px;
            font-weight: 600;
            line-height: 1.6;
            border-left: 5px solid var(--accent);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 35px;
            position: relative;
            z-index: 1;
        }
        
        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 50px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #5BC46E);
            color: white;
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--accent), #FFE66D);
            color: var(--text-dark);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #FF9142);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-icon {
            font-size: 1.3em;
        }
        
        .story-mode {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 3px solid var(--success);
            padding: 40px;
            border-radius: 24px;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(107, 207, 127, 0.2);
        }
        
        .story-text {
            font-size: 1.8em;
            line-height: 2;
            color: var(--text-dark);
            margin-bottom: 30px;
            font-weight: 500;
        }
        
        .story-text .highlight {
            background: linear-gradient(180deg, transparent 60%, var(--accent) 60%);
            padding: 2px 6px;
            font-weight: 800;
            color: var(--text-dark);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .story-text .highlight:hover {
            background: var(--accent);
            transform: scale(1.1);
        }
        
        .settings-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            border: 3px solid var(--accent);
        }
        
        .settings-panel h4 {
            color: var(--text-dark);
            margin-bottom: 18px;
            font-size: 1.3em;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-input {
            width: 100%;
            padding: 16px 20px;
            border: 3px solid #fbbf24;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            margin-bottom: 12px;
            transition: all 0.3s;
            background: white;
        }
        
        .api-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 107, 157, 0.1);
            transform: translateY(-2px);
        }
        
        .feature-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .pill {
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-dark);
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 60px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            animation: popup 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            border: 5px solid var(--accent);
        }
        
        @keyframes popup {
            to { transform: translate(-50%, -50%) scale(1); }
        }
        
        .achievement-icon {
            font-size: 6em;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }
        
        .achievement-text {
            font-family: 'Baloo 2', cursive;
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 999;
        }
        
        .auto-gen-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #a78bfa, #c084fc);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 700;
            margin-left: 10px;
        }
        
        .difficulty-easy { background: #dcfce7; color: #166534; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // AI Word Generator - Creates contextual words based on difficulty
        const generateWordsWithAI = async (level, count, apiKey) => {
            if (!apiKey) return null;
            
            const prompts = {
                level1: "Generate 10 simple 3-letter CVC (consonant-vowel-consonant) words for a child learning to read. Words should be common, easy to visualize (cat, dog, sun). Return ONLY a JSON array of words, nothing else.",
                level2: "Generate 10 word family words (like -at family: cat, hat, mat or -ing family: ring, sing, king). Mix different word families. Return ONLY a JSON array of words.",
                level3: "Generate 10 common sight words that children need to recognize instantly (like: the, and, you, have, said). Return ONLY a JSON array of words.",
                level4: "Generate 10 multi-syllable words suitable for children (happy, butterfly, elephant, garden). Return ONLY a JSON array of words.",
            };
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 500,
                        messages: [{
                            role: "user",
                            content: prompts[level]
                        }]
                    })
                });
                
                const data = await response.json();
                const wordsText = data.content[0].text;
                const words = JSON.parse(wordsText.trim());
                return words;
            } catch (error) {
                console.error('Error generating words:', error);
                return null;
            }
        };
        
        // Word ‚Üí emoji map for instant illustrated fallback
        const WORD_EMOJIS = {
            cat:'üê±', dog:'üê∂', sun:'‚òÄÔ∏è', hat:'üé©', bat:'ü¶á', run:'üèÉ', hop:'üê∏',
            top:'üåÄ', cup:'‚òï', fan:'üåÄ', fish:'üêü', ship:'üö¢', wish:'‚≠ê', dish:'üçΩÔ∏è',
            cake:'üéÇ', lake:'üèûÔ∏è', make:'üî®', take:'ü§≤', tree:'üå≥', free:'üïäÔ∏è',
            the:'üìñ', and:'‚ûï', you:'üë§', are:'üí¨', have:'ü§≤', they:'üë•', said:'üí¨',
            come:'üëã', some:'üî¢', were:'‚è∞', happy:'üòä', rabbit:'üê∞', garden:'üå∫',
            window:'ü™ü', basket:'üß∫', children:'üëß', morning:'üåÖ', birthday:'üéÇ',
            elephant:'üêò', butterfly:'ü¶ã', bird:'üê¶', ball:'‚öΩ', rain:'üåßÔ∏è',
            book:'üìö', home:'üè†', food:'üçé', play:'üéÆ', sing:'üéµ', jump:'‚¨ÜÔ∏è',
            swim:'üèä', ride:'üö≤', love:'‚ù§Ô∏è', help:'ü§ù', read:'üìñ', draw:'‚úèÔ∏è',
            park:'üå≥', swing:'üé†', sky:'üå§Ô∏è', sea:'üåä', bug:'üêõ', ant:'üêú',
            bee:'üêù', cow:'üêÑ', pig:'üê∑', hen:'üêî', fox:'ü¶ä', owl:'ü¶â',
            king:'üëë', ring:'üíç', sing:'üé§', wing:'ü™∂', duck:'ü¶Ü', truck:'üöõ',
            frog:'üê∏', clock:'üïê', block:'üß±', snow:'‚ùÑÔ∏è', boat:'‚õµ', coat:'üß•',
            goat:'üêê', road:'üõ£Ô∏è', toad:'üê∏', bread:'üçû', head:'üë§', read:'üìö',
            dead:'üíÄ', lead:'‚úèÔ∏è', bead:'üìø', leaf:'üçÉ', beef:'ü•©', feet:'ü¶∂',
            meet:'ü§ù', seed:'üå±', weed:'üåø', feed:'üçº', need:'‚ùó', deed:'üìú',
        };

        // Build a colourful emoji SVG that always renders
        const buildEmojiSVG = (word) => {
            const emoji = WORD_EMOJIS[word.toLowerCase()] || 'üìñ';
            const colours = ['#FFF0F5','#F0FFF4','#FFF9C4','#E3F2FD','#F3E5F5'];
            const bg = colours[word.length % colours.length];
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="350" viewBox="0 0 500 350">
  <rect width="500" height="350" fill="${bg}" rx="20"/>
  <text x="250" y="190" font-size="160" text-anchor="middle" dominant-baseline="middle">${emoji}</text>
  <text x="250" y="310" font-size="32" font-family="Nunito,sans-serif" font-weight="800"
        fill="#4A5568" text-anchor="middle">${word}</text>
</svg>`;
            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        };

        // Fetch a real photo from Wikipedia (free, no API key, works everywhere)
        const fetchWikipediaImage = async (word) => {
            try {
                const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(word)}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return null;
                const data = await res.json();
                if (data.thumbnail && data.thumbnail.source) {
                    // Scale up the thumbnail
                    const src = data.thumbnail.source.replace(/\/\d+px-/, '/400px-');
                    return src;
                }
                return null;
            } catch {
                return null;
            }
        };

        // Main image + caption generator
        const generateEnhancedImage = async (word, apiKey) => {
            // 1. Always build the emoji fallback immediately (shown while loading)
            const fallbackUrl = buildEmojiSVG(word);

            // 2. Try to fetch a real Wikipedia photo
            const wikiUrl = await fetchWikipediaImage(word);
            const photoUrl = wikiUrl || fallbackUrl;

            // 3. If we have an API key, get an AI caption; otherwise write a simple one
            if (apiKey) {
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 120,
                            messages: [{
                                role: "user",
                                content: `You are a fun reading teacher for young children. In 1-2 short, simple sentences, describe the word "${word}" in a way a 5-8 year old will understand. Use easy words. Be cheerful and encouraging!`
                            }]
                        })
                    });
                    const data = await response.json();
                    const caption = data.content[0].text.trim();
                    return { url: photoUrl, fallback: fallbackUrl, caption, isAI: true };
                } catch {
                    // API failed ‚Äî still show image with simple caption
                }
            }

            // Default simple caption
            const simpleCaption = `This is a ${word}! Can you say it out loud? üåü`;
            return { url: photoUrl, fallback: fallbackUrl, caption: simpleCaption, isAI: false };
        };
        
        // Base learning content
        const baseLearningContent = {
            level1: {
                name: "Letter Sounds",
                icon: "üî§",
                words: ["cat", "dog", "sun", "hat", "bat", "run", "hop", "top", "cup", "fan"],
                description: "Learn basic 3-letter words with simple sounds",
                difficulty: "easy"
            },
            level2: {
                name: "Word Families",
                icon: "üë®‚Äçüë©‚Äçüëß",
                words: ["fish", "ship", "wish", "dish", "cake", "lake", "make", "take", "tree", "free"],
                description: "Practice word patterns and rhyming",
                difficulty: "easy"
            },
            level3: {
                name: "Sight Words",
                icon: "üëÄ",
                words: ["the", "and", "you", "are", "have", "they", "said", "come", "some", "were"],
                description: "Common words to recognize instantly",
                difficulty: "medium"
            },
            level4: {
                name: "Longer Words",
                icon: "üìè",
                words: ["happy", "rabbit", "garden", "window", "basket", "children", "morning", "birthday", "elephant", "butterfly"],
                description: "Build confidence with multi-syllable words",
                difficulty: "medium"
            },
            level5: {
                name: "Story Time",
                icon: "üìñ",
                stories: [
                    {
                        title: "The Happy Cat",
                        text: "The cat sat on the mat. The cat was happy. The cat played with a ball. The cat ran and jumped. What a fun day!",
                        focusWords: ["cat", "sat", "mat", "happy", "ball"]
                    },
                    {
                        title: "A Day at the Park",
                        text: "Sam went to the park. He saw a big tree. Birds sang in the tree. Sam played on the swing. He had so much fun!",
                        focusWords: ["park", "tree", "birds", "swing", "fun"]
                    }
                ],
                description: "Read complete stories with comprehension",
                difficulty: "hard"
            }
        };
        
        function ReadBuddyApp() {
            const [currentLevel, setCurrentLevel] = useState('level1');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [apiKey, setApiKey] = useState(localStorage.getItem('anthropicApiKey') || '');
            const [generatedImage, setGeneratedImage] = useState(null);
            const [imageLoading, setImageLoading] = useState(false);
            const [wordsCompleted, setWordsCompleted] = useState(0);
            const [totalWords, setTotalWords] = useState(0);
            const [showAchievement, setShowAchievement] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [learningContent, setLearningContent] = useState(baseLearningContent);
            const [isGeneratingWords, setIsGeneratingWords] = useState(false);
            const [confetti, setConfetti] = useState([]);
            
            const currentContent = learningContent[currentLevel];
            const isStoryMode = currentLevel === 'level5';
            const currentWord = isStoryMode ? null : currentContent.words[currentIndex];
            const currentStory = isStoryMode ? currentContent.stories[currentIndex] : null;
            
            // Text-to-Speech
            const speak = (text, rate = 0.75) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = rate;
                    utterance.pitch = 1.1;
                    utterance.volume = 1;
                    
                    utterance.onstart = () => setIsSpeaking(true);
                    utterance.onend = () => setIsSpeaking(false);
                    
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Text-to-speech not supported. Please use Chrome or Safari.');
                }
            };
            
            // Generate new image with AI
            const generateImage = async (word) => {
                setImageLoading(true);
                setGeneratedImage(null);
                
                const result = await generateEnhancedImage(word, apiKey);
                setGeneratedImage(result);
                setImageLoading(false);
            };
            
            // Auto-generate image when word changes
            useEffect(() => {
                if (currentWord) {
                    generateImage(currentWord);
                }
            }, [currentWord]);
            
            // Progress tracking
            useEffect(() => {
                const completed = parseInt(localStorage.getItem('wordsCompleted') || '0');
                const total = parseInt(localStorage.getItem('totalWords') || '0');
                setWordsCompleted(completed);
                setTotalWords(total);
            }, []);
            
            // Confetti effect
            const createConfetti = () => {
                const colors = ['#FF6B9D', '#4ECDC4', '#FFD93D', '#6BCF7F', '#FFA756'];
                const newConfetti = [];
                for (let i = 0; i < 50; i++) {
                    newConfetti.push({
                        id: i,
                        left: Math.random() * 100 + '%',
                        backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                        animationDelay: Math.random() * 2 + 's'
                    });
                }
                setConfetti(newConfetti);
                setTimeout(() => setConfetti([]), 3000);
            };
            
            const markComplete = () => {
                const newCompleted = wordsCompleted + 1;
                const newTotal = totalWords + 1;
                setWordsCompleted(newCompleted);
                setTotalWords(newTotal);
                localStorage.setItem('wordsCompleted', newCompleted);
                localStorage.setItem('totalWords', newTotal);
                
                if (newCompleted % 10 === 0) {
                    setShowAchievement(true);
                    createConfetti();
                    setTimeout(() => setShowAchievement(false), 3000);
                }
                
                nextWord();
            };
            
            const nextWord = () => {
                const maxIndex = isStoryMode ? currentContent.stories.length - 1 : currentContent.words.length - 1;
                if (currentIndex < maxIndex) {
                    setCurrentIndex(currentIndex + 1);
                    setGeneratedImage(null);
                } else {
                    alert('üéâ Level Complete! Amazing work!');
                    setCurrentIndex(0);
                }
            };
            
            const previousWord = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                    setGeneratedImage(null);
                }
            };
            
            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('anthropicApiKey', key);
            };
            
            // Generate new words for current level
            const generateNewWords = async () => {
                if (!apiKey) {
                    alert('Please add your API key to generate new words!');
                    return;
                }
                
                setIsGeneratingWords(true);
                const newWords = await generateWordsWithAI(currentLevel, 10, apiKey);
                
                if (newWords) {
                    setLearningContent(prev => ({
                        ...prev,
                        [currentLevel]: {
                            ...prev[currentLevel],
                            words: newWords
                        }
                    }));
                    setCurrentIndex(0);
                    alert('‚ú® Generated 10 new words! Let\'s learn!');
                } else {
                    alert('Could not generate words. Check your API key.');
                }
                
                setIsGeneratingWords(false);
            };
            
            return (
                <>
                    <div className="header">
                        <div className="header-content">
                            <div className="logo">
                                <span className="logo-icon">üìö</span>
                                <div className="logo-text">
                                    <h1>ReadBuddy</h1>
                                </div>
                            </div>
                            <p className="tagline">Your AI-Powered Reading Adventure!</p>
                        </div>
                    </div>
                    
                    <div className="main-container">
                        <div className="sidebar">
                            <div className="level-selector">
                                <h3>üéØ Choose Level</h3>
                                {Object.entries(learningContent).map(([key, level]) => (
                                    <button
                                        key={key}
                                        className={`level-btn ${currentLevel === key ? 'active' : ''}`}
                                        onClick={() => {
                                            setCurrentLevel(key);
                                            setCurrentIndex(0);
                                            setGeneratedImage(null);
                                        }}
                                    >
                                        <span className="level-icon">{level.icon}</span>
                                        <span>{level.name}</span>
                                    </button>
                                ))}
                            </div>
                            
                            <div className="progress-section">
                                <h3>üìä Your Progress</h3>
                                <div className="progress-bar-container">
                                    <div 
                                        className="progress-fill" 
                                        style={{width: `${totalWords > 0 ? (wordsCompleted / totalWords) * 100 : 0}%`}}
                                    ></div>
                                </div>
                                <div className="progress-text">
                                    {wordsCompleted} / {totalWords} words mastered
                                </div>
                                
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <div className="stat-number">{wordsCompleted}</div>
                                        <div className="stat-label">Words Learned</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-number">{Math.floor(wordsCompleted / 10)}</div>
                                        <div className="stat-label">Achievements</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="content-area">
                            <div className="lesson-header">
                                <div className="lesson-title">
                                    <h2>{currentContent.icon} {currentContent.name}</h2>
                                    <span className={`difficulty-badge difficulty-${currentContent.difficulty}`}>
                                        {currentContent.difficulty.toUpperCase()}
                                    </span>
                                </div>
                                {!isStoryMode && (
                                    <div className="word-counter">
                                        Word {currentIndex + 1} of {currentContent.words.length}
                                    </div>
                                )}
                            </div>
                            
                            <div className="lesson-card">
                                {!isStoryMode ? (
                                    <>
                                        <div className="word-display">
                                            <div className="current-word" onClick={() => speak(currentWord)}>
                                                {currentWord}
                                            </div>
                                            <div className="phonetic-text">Click word to hear it!</div>
                                        </div>
                                        
                                        {imageLoading && (
                                            <div className="image-container">
                                                <div className="image-loading">
                                                    üé®
                                                    <div className="loading-text">Creating image...</div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {generatedImage && !imageLoading && (
                                            <div className="image-container">
                                                <img
                                                    src={generatedImage.url}
                                                    alt={currentWord}
                                                    onError={(e) => {
                                                        if (generatedImage.fallback && e.target.src !== generatedImage.fallback) {
                                                            e.target.src = generatedImage.fallback;
                                                        }
                                                    }}
                                                />
                                            </div>
                                        )}
                                        
                                        {generatedImage && (
                                            <div className="caption">
                                                {generatedImage.isAI && <span style={{fontSize: '0.7em'}}>ü§ñ AI: </span>}
                                                {generatedImage.caption}
                                            </div>
                                        )}
                                        
                                        <div className="controls">
                                            <button 
                                                className="btn btn-primary"
                                                onClick={() => speak(currentWord)}
                                                disabled={isSpeaking}
                                            >
                                                <span className="btn-icon">üîä</span>
                                                {isSpeaking ? 'Speaking...' : 'Hear Word'}
                                            </button>
                                            <button 
                                                className="btn btn-secondary"
                                                onClick={() => speak(currentWord, 0.5)}
                                            >
                                                <span className="btn-icon">üêå</span>
                                                Slow Speed
                                            </button>
                                            <button 
                                                className="btn btn-accent"
                                                onClick={() => generateImage(currentWord)}
                                                disabled={imageLoading}
                                            >
                                                <span className="btn-icon">üé®</span>
                                                {imageLoading ? 'Creating...' : 'New Image'}
                                            </button>
                                        </div>
                                        
                                        <div className="controls" style={{marginTop: '20px'}}>
                                            <button 
                                                className="btn btn-secondary"
                                                onClick={previousWord}
                                                disabled={currentIndex === 0}
                                            >
                                                ‚Üê Previous
                                            </button>
                                            <button 
                                                className="btn btn-success"
                                                onClick={markComplete}
                                            >
                                                <span className="btn-icon">‚úì</span>
                                                Got It! Next ‚Üí
                                            </button>
                                        </div>
                                        
                                        {apiKey && currentLevel !== 'level5' && (
                                            <div className="controls" style={{marginTop: '15px'}}>
                                                <button 
                                                    className="btn btn-warning"
                                                    onClick={generateNewWords}
                                                    disabled={isGeneratingWords}
                                                >
                                                    <span className="btn-icon">‚ú®</span>
                                                    {isGeneratingWords ? 'Generating...' : 'Generate New Words with AI'}
                                                </button>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <>
                                        <div className="story-mode">
                                            <h3 style={{color: 'var(--success)', marginBottom: '25px', fontSize: '2.2em', fontFamily: "'Baloo 2', cursive"}}>
                                                {currentStory.title}
                                            </h3>
                                            <div className="story-text">
                                                {currentStory.text.split(' ').map((word, i) => {
                                                    const cleanWord = word.replace(/[.,!?]/g, '').toLowerCase();
                                                    const isHighlight = currentStory.focusWords.includes(cleanWord);
                                                    return (
                                                        <span 
                                                            key={i}
                                                            className={isHighlight ? 'highlight' : ''}
                                                            onClick={() => isHighlight && speak(cleanWord)}
                                                        >
                                                            {word}{' '}
                                                        </span>
                                                    );
                                                })}
                                            </div>
                                            
                                            <div className="controls">
                                                <button 
                                                    className="btn btn-primary"
                                                    onClick={() => speak(currentStory.text, 0.85)}
                                                    disabled={isSpeaking}
                                                >
                                                    <span className="btn-icon">üîä</span>
                                                    {isSpeaking ? 'Reading...' : 'Read Story'}
                                                </button>
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => speak(currentStory.text, 0.6)}
                                                >
                                                    <span className="btn-icon">üêå</span>
                                                    Slow Reading
                                                </button>
                                            </div>
                                            
                                            <div className="controls" style={{marginTop: '20px'}}>
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={previousWord}
                                                    disabled={currentIndex === 0}
                                                >
                                                    ‚Üê Previous Story
                                                </button>
                                                <button 
                                                    className="btn btn-success"
                                                    onClick={markComplete}
                                                >
                                                    <span className="btn-icon">‚úì</span>
                                                    Story Complete! ‚Üí
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                            
                            <div className="settings-panel">
                                <h4>üîë AI Settings</h4>
                                <input 
                                    type="password"
                                    className="api-input"
                                    placeholder="Paste your Anthropic API key here (optional)"
                                    value={apiKey}
                                    onChange={(e) => saveApiKey(e.target.value)}
                                />
                                <p style={{fontSize: '0.95em', color: 'var(--text-dark)', marginBottom: '15px'}}>
                                    Get your free API key at <a href="https://console.anthropic.com" target="_blank" style={{color: 'var(--primary)', fontWeight: 700}}>console.anthropic.com</a> ($5 free credit!)
                                </p>
                                
                                <div className="feature-pills">
                                    <div className="pill">
                                        <span>‚ú®</span>
                                        AI Image Descriptions
                                    </div>
                                    <div className="pill">
                                        <span>üé≤</span>
                                        Auto-Generate Words
                                    </div>
                                    <div className="pill">
                                        <span>üìñ</span>
                                        Custom Stories (Coming Soon)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {showAchievement && (
                        <div className="achievement-popup">
                            <div className="achievement-icon">üèÜ</div>
                            <div className="achievement-text">Amazing Work!</div>
                            <p style={{fontSize: '1.3em', color: 'var(--text-light)', fontWeight: 600}}>
                                You've learned {wordsCompleted} words! Keep it up! üåü
                            </p>
                        </div>
                    )}
                    
                    {confetti.map(item => (
                        <div
                            key={item.id}
                            className="confetti"
                            style={{
                                left: item.left,
                                backgroundColor: item.backgroundColor,
                                animationDelay: item.animationDelay,
                                animation: 'confetti-fall 3s linear forwards'
                            }}
                        />
                    ))}
                </>
            );
        }
        
        ReactDOM.render(<ReadBuddyApp />, document.getElementById('root'));
    </script>
</body>
</html>