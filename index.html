<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadBuddy üåü Kids Reading App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF6B9D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ReadBuddy">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --pink:   #FF6B9D;
            --teal:   #3DD9CB;
            --yellow: #FFD93D;
            --purple: #A78BFA;
            --orange: #FF9A3C;
            --green:  #5DD882;
            --blue:   #4A90E2;
            --bg:     #FFF8F0;
            --card:   #FFFFFF;
            --text:   #2D2D2D;
            --muted:  #888;
            --shadow: 0 8px 32px rgba(0,0,0,0.10);
            --r: 24px;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255,107,157,0.07) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(61,217,203,0.07) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255,217,61,0.05) 0%, transparent 60%);
        }

        #root { max-width: 1200px; margin: 0 auto; padding: 16px; }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, #FF6B9D 0%, #FF9A3C 50%, #FFD93D 100%);
            border-radius: var(--r);
            padding: 28px 32px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 32px rgba(255,107,157,0.3);
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .logo-emoji { font-size: 3em; animation: bounce 2s infinite; }
        @keyframes bounce {
            0%,100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .header h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 2.6em;
            color: white;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.15);
            letter-spacing: 1px;
        }
        .header-tagline { color: rgba(255,255,255,0.9); font-weight: 700; font-size: 1em; }
        .stars-badge {
            background: white;
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: 900;
            font-size: 1.1em;
            color: var(--pink);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
        }
        @media(max-width: 780px) {
            .layout { grid-template-columns: 1fr; }
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar {
            background: var(--card);
            border-radius: var(--r);
            padding: 24px 18px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 16px;
        }
        .sidebar h3 {
            font-family: 'Fredoka One', cursive;
            font-size: 1.2em;
            color: var(--text);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .age-btn {
            width: 100%;
            padding: 13px 14px;
            margin-bottom: 8px;
            border: 3px solid transparent;
            border-radius: 14px;
            background: #f7f7f7;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-size: 0.95em;
            font-weight: 800;
            transition: all 0.25s cubic-bezier(.34,1.56,.64,1);
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }
        .age-btn:hover { transform: translateX(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--pink); }
        .age-btn.active { background: linear-gradient(135deg, var(--pink), #FF8FB1); color: white; border-color: #E85384; transform: scale(1.03); box-shadow: 0 6px 20px rgba(255,107,157,0.35); }
        .age-btn .age-icon { font-size: 1.6em; }
        .age-btn .age-info { flex: 1; }
        .age-btn .age-name { display: block; font-weight: 900; }
        .age-btn .age-range { display: block; font-size: 0.78em; opacity: 0.75; font-weight: 600; }

        .progress-wrap { margin-top: 24px; padding-top: 20px; border-top: 2px dashed #eee; }
        .prog-bar-bg {
            background: #eee;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0 8px;
        }
        .prog-bar-fill {
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, var(--green), var(--teal));
            transition: width 0.7s cubic-bezier(.34,1.56,.64,1);
        }
        .prog-label { font-weight: 700; font-size: 0.9em; color: var(--muted); text-align: center; }
        .stat-row { display: flex; gap: 10px; margin-top: 14px; }
        .stat-box {
            flex: 1;
            background: #f7f7f7;
            border-radius: 14px;
            padding: 12px 8px;
            text-align: center;
            border: 2px solid #eee;
        }
        .stat-num { font-family: 'Fredoka One', cursive; font-size: 1.8em; color: var(--pink); }
        .stat-lbl { font-size: 0.75em; font-weight: 700; color: var(--muted); }

        /* ‚îÄ‚îÄ Main content ‚îÄ‚îÄ */
        .content {
            background: var(--card);
            border-radius: var(--r);
            padding: 32px;
            box-shadow: var(--shadow);
            min-height: 500px;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 26px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .content-title {
            font-family: 'Fredoka One', cursive;
            font-size: 1.7em;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .word-count-pill {
            background: var(--yellow);
            border-radius: 20px;
            padding: 6px 18px;
            font-weight: 900;
            font-size: 1em;
            color: #7a5c00;
        }

        /* ‚îÄ‚îÄ Word Card: image LEFT, word+buttons RIGHT ‚îÄ‚îÄ */
        .word-card {
            background: linear-gradient(135deg, #fffef9, #fff5f8);
            border: 3px solid var(--yellow);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 12px 40px rgba(255,217,61,0.2);
            display: flex;
            gap: 32px;
            align-items: stretch;
            position: relative;
            overflow: hidden;
        }
        .word-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 80% 20%, rgba(255,217,61,0.08), transparent 60%);
            pointer-events: none;
        }

        @media(max-width: 620px) {
            .word-card { flex-direction: column; }
        }

        /* Image column */
        .card-image-col {
            flex: 0 0 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .img-frame {
            width: 220px;
            height: 200px;
            border-radius: 18px;
            overflow: hidden;
            background: #f0f4f8;
            border: 3px solid white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .img-frame img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s;
        }
        .img-frame:hover img { transform: scale(1.06); }
        .img-loading {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            animation: pulse-bg 1.5s infinite;
            font-size: 3em;
        }
        @keyframes pulse-bg {
            0%,100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .img-loading span { font-size: 0.25em; margin-top: 10px; color: #5a67d8; font-weight: 700; font-family: 'Nunito'; }

        /* Speak-image button directly under image */
        .img-speak-btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--teal), #2dbfb3);
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 1em;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.25s cubic-bezier(.34,1.56,.64,1);
            box-shadow: 0 4px 14px rgba(61,217,203,0.4);
        }
        .img-speak-btn:hover { transform: translateY(-3px) scale(1.04); box-shadow: 0 8px 22px rgba(61,217,203,0.5); }
        .img-speak-btn:active { transform: scale(0.97); }
        .img-speak-btn.speaking { animation: speak-pulse 0.6s infinite alternate; }
        @keyframes speak-pulse { from { box-shadow: 0 4px 14px rgba(61,217,203,0.4); } to { box-shadow: 0 8px 30px rgba(61,217,203,0.8); } }

        .img-slow-btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--purple), #8b5cf6);
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9em;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.25s cubic-bezier(.34,1.56,.64,1);
            box-shadow: 0 4px 14px rgba(167,139,250,0.4);
        }
        .img-slow-btn:hover { transform: translateY(-2px) scale(1.03); }

        /* Word / info column */
        .card-info-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 16px;
        }
        .big-word {
            font-family: 'Fredoka One', cursive;
            font-size: clamp(2.8em, 8vw, 5em);
            background: linear-gradient(135deg, var(--pink), var(--orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            cursor: pointer;
            transition: transform 0.2s;
            animation: wordIn 0.6s cubic-bezier(.34,1.56,.64,1);
            filter: drop-shadow(3px 3px 0 rgba(255,217,61,0.4));
            user-select: none;
        }
        .big-word:hover { transform: scale(1.07) rotate(-1deg); }
        @keyframes wordIn {
            from { opacity: 0; transform: scale(0.5) rotate(-10deg); }
            to   { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        .phonetic { font-size: 1.1em; color: var(--muted); font-style: italic; font-weight: 600; }

        .caption-box {
            background: rgba(255,217,61,0.15);
            border-left: 5px solid var(--yellow);
            border-radius: 0 14px 14px 0;
            padding: 14px 18px;
            font-size: 1.05em;
            font-weight: 600;
            color: var(--text);
            line-height: 1.6;
        }

        .action-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn {
            padding: 13px 22px;
            border: none;
            border-radius: 50px;
            font-family: 'Nunito', sans-serif;
            font-size: 1em;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(.34,1.56,.64,1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 22px rgba(0,0,0,0.18); }
        .btn:active { transform: translateY(-1px); }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }

        .btn-pink  { background: linear-gradient(135deg, var(--pink),   #E85384); color: white; }
        .btn-green { background: linear-gradient(135deg, var(--green),  #3ab85a); color: white; }
        .btn-blue  { background: linear-gradient(135deg, var(--blue),   #3178c6); color: white; }
        .btn-orange{ background: linear-gradient(135deg, var(--orange), #e07a20); color: white; }

        .nav-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-nav {
            padding: 14px 28px;
            font-size: 1.1em;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
            transition: all 0.25s cubic-bezier(.34,1.56,.64,1);
            box-shadow: 0 4px 14px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-nav:hover { transform: translateY(-3px); box-shadow: 0 8px 22px rgba(0,0,0,0.18); }
        .btn-nav:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-prev { background: #f0f0f0; color: #555; }
        .btn-next { background: linear-gradient(135deg, var(--green), #3ab85a); color: white; }

        /* ‚îÄ‚îÄ Story Mode ‚îÄ‚îÄ */
        .story-card {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 3px solid var(--green);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(93,216,130,0.2);
        }
        .story-title {
            font-family: 'Fredoka One', cursive;
            font-size: 2em;
            color: #166534;
            margin-bottom: 20px;
        }
        .story-body {
            font-size: 1.5em;
            line-height: 2.2;
            color: var(--text);
            font-weight: 600;
        }
        .story-word {
            display: inline-block;
            background: linear-gradient(180deg, transparent 60%, var(--yellow) 60%);
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
        }
        .story-word:hover { background: var(--yellow); transform: scale(1.1); }

        .story-controls { margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ Achievement popup ‚îÄ‚îÄ */
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-box {
            background: white;
            border-radius: 30px;
            padding: 52px 60px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            border: 5px solid var(--yellow);
            animation: popIn 0.5s cubic-bezier(.34,1.56,.64,1);
            max-width: 90%;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }
        .ach-icon { font-size: 5em; animation: bounce 1s infinite; }
        .ach-title {
            font-family: 'Fredoka One', cursive;
            font-size: 2.2em;
            background: linear-gradient(135deg, var(--pink), var(--teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 14px 0 8px;
        }
        .ach-sub { font-size: 1.1em; font-weight: 600; color: var(--muted); }

        /* Confetti */
        @keyframes fall {
            0%   { transform: translateY(-40px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(105vh) rotate(720deg); opacity: 0; }
        }
        .conf-piece {
            position: fixed;
            width: 10px; height: 10px;
            border-radius: 3px;
            animation: fall 2.5s linear forwards;
            z-index: 1000;
            pointer-events: none;
        }

        /* Age group color bands */
        .age-toddler   { --level-color: #FF6B9D; }
        .age-preschool { --level-color: #FF9A3C; }
        .age-early     { --level-color: #3DD9CB; }
        .age-mid       { --level-color: #A78BFA; }
        .age-advanced  { --level-color: #4A90E2; }

        .level-badge {
            display: inline-block;
            background: var(--level-color, var(--pink));
            color: white;
            border-radius: 20px;
            padding: 4px 14px;
            font-size: 0.8em;
            font-weight: 800;
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const AGE_LEVELS = [
    {
        id: 'toddler',
        icon: 'üçº',
        name: 'Baby Words',
        range: 'Ages 1‚Äì2',
        cls: 'age-toddler',
        badge: 'TODDLER',
        words: ['cat','dog','ball','cup','hat','sun','bed','car','bus','hen','bee','ant','cow','pig','duck','fish','frog','bird','star','moon'],
        story: null,
        hint: 'Click the picture or word to hear it!'
    },
    {
        id: 'preschool',
        icon: 'üåà',
        name: 'Colorful Words',
        range: 'Ages 3‚Äì4',
        cls: 'age-preschool',
        badge: 'PRESCHOOL',
        words: ['apple','kite','cake','rain','boat','tree','book','frog','jump','farm','flower','cloud','swing','baby','happy'],
        story: null,
        hint: 'Big, fun words! Tap to listen!'
    },
    {
        id: 'early',
        icon: 'üìñ',
        name: 'First Reader',
        range: 'Ages 5‚Äì6',
        cls: 'age-early',
        badge: 'EARLY',
        words: ['hat','bat','cat','mat','rat','hop','mop','top','pop','ship','chip','trip','drip','slip','clap','snap','trap'],
        story: {
            title: 'The Big Red Cat',
            text: 'The cat sat on a mat. The cat had a hat. The big red cat ran to the van. What fun!',
            focus: ['cat','mat','hat','ran','van','fun']
        },
        hint: 'Word families ‚Äî they rhyme!'
    },
    {
        id: 'mid',
        icon: 'ü¶ã',
        name: 'Growing Reader',
        range: 'Ages 7‚Äì9',
        cls: 'age-mid',
        badge: 'GRADE 1-3',
        words: ['happy','rabbit','garden','window','basket','morning','elephant','butterfly','children','birthday','playing','jumping','running','singing','laughing'],
        story: {
            title: 'A Day at the Park',
            text: 'Sam went to the park on a bright morning. He saw a rabbit jumping in the garden. Birds were singing in the window tree. Sam played and laughed with the children. It was a very happy birthday!',
            focus: ['park','rabbit','garden','morning','children','happy']
        },
        hint: 'Multi-syllable words ‚Äî sound them out!'
    },
    {
        id: 'advanced',
        icon: 'üöÄ',
        name: 'Super Reader',
        range: 'Ages 10‚Äì12',
        cls: 'age-advanced',
        badge: 'GRADES 4-6',
        words: ['adventure','discovery','imagination','celebration','friendship','important','beautiful','wonderful','mysterious','fascinating','challenge','environment','responsible','courageous','extraordinary'],
        story: {
            title: 'The Mysterious Discovery',
            text: 'Maya loved adventure more than anything. One extraordinary morning, she made a fascinating discovery in the garden. A mysterious door appeared between the trees. With courageous steps, she opened it ‚Äî and a whole new world of imagination and wonder was waiting inside!',
            focus: ['adventure','extraordinary','fascinating','mysterious','courageous','imagination']
        },
        hint: 'Big words for big readers!'
    }
];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Emoji fallback map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const EMOJI_MAP = {
    cat:'üê±',dog:'üê∂',ball:'‚öΩ',cup:'‚òï',hat:'üé©',sun:'‚òÄÔ∏è',bed:'üõèÔ∏è',car:'üöó',bus:'üöå',
    hen:'üêî',bee:'üêù',ant:'üêú',cow:'üêÑ',pig:'üê∑',duck:'ü¶Ü',fish:'üêü',frog:'üê∏',
    bird:'üê¶',star:'‚≠ê',moon:'üåô',apple:'üçé',kite:'ü™Å',cake:'üéÇ',rain:'üåßÔ∏è',boat:'‚õµ',
    tree:'üå≥',book:'üìö',jump:'‚¨ÜÔ∏è',farm:'üè°',flower:'üå∏',cloud:'‚òÅÔ∏è',swing:'üé†',
    baby:'üë∂',happy:'üòä',hat:'üé©',bat:'ü¶á',ship:'üö¢',chip:'üçü',clap:'üëè',
    rabbit:'üê∞',garden:'üå∫',window:'ü™ü',basket:'üß∫',morning:'üåÖ',elephant:'üêò',
    butterfly:'ü¶ã',children:'üëß',birthday:'üéÇ',playing:'üéÆ',jumping:'üèÉ',running:'üèÉ',
    singing:'üéµ',laughing:'üòÇ',adventure:'üó∫Ô∏è',discovery:'üîç',imagination:'üí≠',
    celebration:'üéâ',friendship:'ü§ù',important:'‚ùó',beautiful:'‚ú®',wonderful:'üåü',
    mysterious:'üîÆ',fascinating:'ü§©',challenge:'üí™',environment:'üåç',responsible:'ü¶∏',
    courageous:'‚öîÔ∏è',extraordinary:'üöÄ',park:'üå≥',mat:'üü´',ran:'üèÉ',van:'üöê',fun:'üéä',
    sat:'üí∫',big:'üìê',red:'üî¥',
};

const buildEmojiSVG = (word) => {
    const emoji = EMOJI_MAP[word.toLowerCase()] || 'üìñ';
    const palettes = [['#FFF0F5','#FF6B9D'],['#F0FFF4','#3DD9CB'],['#FFFDE7','#FFD93D'],['#EDE9FE','#A78BFA'],['#EFF6FF','#4A90E2']];
    const [bg, accent] = palettes[word.length % palettes.length];
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
  <rect width="400" height="300" fill="${bg}" rx="16"/>
  <circle cx="200" cy="130" r="90" fill="${accent}" opacity="0.15"/>
  <text x="200" y="155" font-size="120" text-anchor="middle" dominant-baseline="middle">${emoji}</text>
</svg>`;
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
};

const fetchWikiImage = async (word) => {
    try {
        const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(word)}`);
        if (!res.ok) return null;
        const data = await res.json();
        if (data.thumbnail?.source) return data.thumbnail.source.replace(/\/\d+px-/, '/400px-');
        return null;
    } catch { return null; }
};

const getImageAndCaption = async (word, apiKey) => {
    const fallback = buildEmojiSVG(word);
    const wikiUrl = await fetchWikiImage(word);
    const url = wikiUrl || fallback;

    if (apiKey) {
        try {
            const res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'anthropic-version': '2023-06-01' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 100,
                    messages: [{ role: 'user', content: `Write 1 short, cheerful, child-friendly sentence about the word "${word}" for a 5-year-old. Keep it under 15 words.` }]
                })
            });
            const d = await res.json();
            return { url, fallback, caption: d.content[0].text.trim(), ai: true };
        } catch {}
    }

    const captions = {
        default: `This is a ${word}! Can you say it? üåü`,
    };
    return { url, fallback, caption: EMOJI_MAP[word.toLowerCase()] ? `${EMOJI_MAP[word.toLowerCase()]} A ${word}! Great word!` : `This is a ${word}! üåü`, ai: false };
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function ReadBuddyApp() {
    const [levelId, setLevelId] = useState('toddler');
    const [idx, setIdx] = useState(0);
    const [mode, setMode] = useState('word'); // 'word' | 'story'
    const [imgData, setImgData] = useState(null);
    const [imgLoading, setImgLoading] = useState(false);
    const [speaking, setSpeaking] = useState(false);
    const [apiKey] = useState(''); // users can add their key if desired
    const [wordsLearned, setWordsLearned] = useState(() => parseInt(sessionStorage.getItem('wl') || '0'));
    const [achievement, setAchievement] = useState(false);
    const [confetti, setConfetti] = useState([]);
    const [storyMode, setStoryMode] = useState(false);

    const level = AGE_LEVELS.find(l => l.id === levelId);
    const word = level.words[idx];
    const story = level.story;

    /* Speak */
    const speak = useCallback((text, rate = 0.8) => {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = rate;
        u.pitch = 1.1;
        u.volume = 1;
        u.onstart = () => setSpeaking(true);
        u.onend   = () => setSpeaking(false);
        window.speechSynthesis.speak(u);
    }, []);

    /* Load image */
    useEffect(() => {
        if (storyMode) return;
        let cancelled = false;
        setImgLoading(true);
        setImgData(null);
        getImageAndCaption(word, apiKey).then(data => {
            if (!cancelled) { setImgData(data); setImgLoading(false); }
        });
        return () => { cancelled = true; };
    }, [word, storyMode]);

    /* Auto-speak the word when it changes */
    useEffect(() => {
        if (!storyMode && word) {
            const t = setTimeout(() => speak(word), 400);
            return () => clearTimeout(t);
        }
    }, [word, storyMode]);

    const changeLevel = (id) => {
        setLevelId(id);
        setIdx(0);
        setStoryMode(false);
        setImgData(null);
    };

    const next = () => {
        if (idx < level.words.length - 1) { setIdx(idx + 1); setImgData(null); }
        else { alert('üéâ You finished all words! Amazing!'); setIdx(0); }
    };
    const prev = () => { if (idx > 0) { setIdx(idx - 1); setImgData(null); } };

    const markGotIt = () => {
        const n = wordsLearned + 1;
        setWordsLearned(n);
        sessionStorage.setItem('wl', n);
        if (n % 5 === 0) {
            setAchievement(true);
            const pieces = Array.from({length: 60}, (_, i) => ({
                id: i,
                x: Math.random() * 100,
                color: ['#FF6B9D','#FFD93D','#3DD9CB','#A78BFA','#FF9A3C'][i % 5],
                delay: Math.random() * 1.5,
                size: 6 + Math.random() * 8
            }));
            setConfetti(pieces);
            setTimeout(() => { setAchievement(false); setConfetti([]); }, 3200);
        }
        next();
    };

    const hasStory = !!story;

    return (
        <>
            {/* Header */}
            <div className="header">
                <div className="header-left">
                    <span className="logo-emoji">üìö</span>
                    <div>
                        <h1>ReadBuddy</h1>
                        <div className="header-tagline">üåü Learning is fun for every age!</div>
                    </div>
                </div>
                <div className="stars-badge">‚≠ê {wordsLearned} words learned!</div>
            </div>

            <div className="layout">
                {/* Sidebar */}
                <aside className="sidebar">
                    <h3>üéØ Choose Your Level</h3>
                    {AGE_LEVELS.map(l => (
                        <button
                            key={l.id}
                            className={`age-btn ${l.cls} ${levelId === l.id ? 'active' : ''}`}
                            onClick={() => changeLevel(l.id)}
                        >
                            <span className="age-icon">{l.icon}</span>
                            <span className="age-info">
                                <span className="age-name">{l.name}</span>
                                <span className="age-range">{l.range}</span>
                            </span>
                        </button>
                    ))}

                    <div className="progress-wrap">
                        <h3>üìä Progress</h3>
                        <div className="prog-bar-bg">
                            <div className="prog-bar-fill" style={{width: `${Math.min(100, (wordsLearned % 10) * 10)}%`}}></div>
                        </div>
                        <div className="prog-label">Next star in {10 - (wordsLearned % 10)} words!</div>
                        <div className="stat-row">
                            <div className="stat-box">
                                <div className="stat-num">{wordsLearned}</div>
                                <div className="stat-lbl">Learned</div>
                            </div>
                            <div className="stat-box">
                                <div className="stat-num">{Math.floor(wordsLearned / 5)}</div>
                                <div className="stat-lbl">Stars ‚≠ê</div>
                            </div>
                        </div>
                    </div>
                </aside>

                {/* Main */}
                <main className="content">
                    <div className="content-header">
                        <div className="content-title">
                            {level.icon} {level.name}
                            <span className={`level-badge ${level.cls}`}>{level.badge}</span>
                        </div>
                        <div style={{display:'flex', gap:'10px', flexWrap:'wrap'}}>
                            {hasStory && (
                                <button
                                    className={`btn ${storyMode ? 'btn-orange' : 'btn-blue'}`}
                                    onClick={() => setStoryMode(!storyMode)}
                                >
                                    {storyMode ? 'üî§ Words' : 'üìñ Story'}
                                </button>
                            )}
                            {!storyMode && (
                                <div className="word-count-pill">
                                    {idx + 1} / {level.words.length}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* ‚îÄ‚îÄ WORD MODE ‚îÄ‚îÄ */}
                    {!storyMode && (
                        <>
                            <div className="word-card">
                                {/* LEFT: image + buttons beside it */}
                                <div className="card-image-col">
                                    <div className="img-frame">
                                        {imgLoading && (
                                            <div className="img-loading">
                                                üé®
                                                <span>Loading...</span>
                                            </div>
                                        )}
                                        {imgData && !imgLoading && (
                                            <img
                                                src={imgData.url}
                                                alt={word}
                                                onError={e => { if (imgData.fallback && e.target.src !== imgData.fallback) e.target.src = imgData.fallback; }}
                                            />
                                        )}
                                    </div>

                                    {/* ‚úÖ Clickable buttons BESIDE (below) the image */}
                                    <button
                                        className={`img-speak-btn ${speaking ? 'speaking' : ''}`}
                                        onClick={() => speak(word)}
                                        disabled={speaking}
                                    >
                                        üîä {speaking ? 'Saying...' : 'Say it!'}
                                    </button>
                                    <button
                                        className="img-slow-btn"
                                        onClick={() => speak(word, 0.45)}
                                    >
                                        üêå Slow
                                    </button>
                                </div>

                                {/* RIGHT: word + info */}
                                <div className="card-info-col">
                                    <div>
                                        <div
                                            className="big-word"
                                            onClick={() => speak(word)}
                                            title="Click to hear!"
                                        >
                                            {word}
                                        </div>
                                        <div className="phonetic">üëÜ Tap the word to hear it!</div>
                                        <div style={{marginTop:'6px', fontSize:'0.85em', color:'var(--muted)', fontWeight:700}}>
                                            {level.hint}
                                        </div>
                                    </div>

                                    {imgData && (
                                        <div className="caption-box">
                                            {imgData.ai && <span style={{fontSize:'0.75em', color:'#7c3aed', fontWeight:800}}>ü§ñ AI says: </span>}
                                            {imgData.caption}
                                        </div>
                                    )}

                                    <div className="action-btns">
                                        <button className="btn btn-pink" onClick={() => speak(word)} disabled={speaking}>
                                            üîä {speaking ? 'Speaking...' : 'Hear Word'}
                                        </button>
                                        <button className="btn btn-green" onClick={markGotIt}>
                                            ‚úÖ Got it!
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Nav */}
                            <div className="nav-row">
                                <button className="btn-nav btn-prev" onClick={prev} disabled={idx === 0}>
                                    ‚Üê Back
                                </button>
                                <button className="btn-nav btn-next" onClick={next} disabled={idx === level.words.length - 1}>
                                    Next Word ‚Üí
                                </button>
                            </div>
                        </>
                    )}

                    {/* ‚îÄ‚îÄ STORY MODE ‚îÄ‚îÄ */}
                    {storyMode && story && (
                        <div className="story-card">
                            <div className="story-title">üìñ {story.title}</div>
                            <div className="story-body">
                                {story.text.split(' ').map((w, i) => {
                                    const clean = w.replace(/[.,!?]/g,'').toLowerCase();
                                    const isKey = story.focus.includes(clean);
                                    return (
                                        <span key={i}>
                                            {isKey ? (
                                                <span className="story-word" onClick={() => speak(clean)}>{w}</span>
                                            ) : w}{' '}
                                        </span>
                                    );
                                })}
                            </div>
                            <div className="story-controls">
                                <button className="btn btn-pink" onClick={() => speak(story.text, 0.82)} disabled={speaking}>
                                    üîä {speaking ? 'Reading...' : 'Read Story'}
                                </button>
                                <button className="btn btn-blue" onClick={() => speak(story.text, 0.55)}>
                                    üêå Read Slowly
                                </button>
                                <button className="btn btn-green" onClick={() => { setStoryMode(false); markGotIt(); }}>
                                    ‚úÖ Story Done!
                                </button>
                            </div>
                            <p style={{marginTop:'18px', color:'var(--muted)', fontWeight:700, fontSize:'0.95em'}}>
                                üí° Tap the <span style={{background:'var(--yellow)', padding:'2px 6px', borderRadius:'4px', color:'#7a5c00'}}>highlighted words</span> to hear them!
                            </p>
                        </div>
                    )}
                </main>
            </div>

            {/* Achievement popup */}
            {achievement && (
                <div className="overlay" onClick={() => setAchievement(false)}>
                    <div className="achievement-box" onClick={e => e.stopPropagation()}>
                        <div className="ach-icon">üèÜ</div>
                        <div className="ach-title">You're Amazing!</div>
                        <div className="ach-sub">You've learned {wordsLearned} words! Keep going! üåü</div>
                        <button className="btn btn-green" style={{margin:'20px auto 0', fontSize:'1.1em'}} onClick={() => setAchievement(false)}>
                            üéâ Yay!
                        </button>
                    </div>
                </div>
            )}

            {/* Confetti */}
            {confetti.map(p => (
                <div key={p.id} className="conf-piece" style={{
                    left: p.x + '%',
                    top: '-20px',
                    width: p.size + 'px',
                    height: p.size + 'px',
                    background: p.color,
                    animationDelay: p.delay + 's',
                    animationDuration: '2.5s'
                }} />
            ))}
        </>
    );
}

ReactDOM.render(<ReadBuddyApp />, document.getElementById('root'));
</script>
</body>
</html>
